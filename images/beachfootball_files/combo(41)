YUI.add("photostream-route",function(e){function t(e){t.superclass.constructor.call(this,e)}var o=require("hermes-core/type-validator"),i="pu";e.Routes[this.name]=t,e.extend(t,e.FlickrRoute,{langBundles:this.details.langBundles,run:function(t){var r,s,a,n=this,l=t.params.nsid_or_path_alias,p=!!t.headers&&t.headers["user-agent"],d=t.params&&t.params.photo_id,u=d?100:25,h=this.getPageNumber(t),m={},c=[],g=this.appContext.getViewer(),f=t.geo;p&&null!==p.match(/^Twitterbot/i)?this.isTwitterbot=!0:this.isTwitterbot=!1,this.isEdit=t.params&&t.params.edit,s=this.isEdit?"/photos/"+l+"/edit/":"/photos/"+l+"/";var P=t.query&&""===t.query.helloPro||!1;return r={page:100/u*(h-1)+1,perPage:u,withPhotoId:d},r.orderBy="use_pref",r.viewAs="use_pref",r.createCompoundID=!0,o.nsid(l)?m.id=l:m.pathAlias=l,(g.signedIn||t.probableUser)&&(c.push(this.appContext.getModel("person-preferences-models",g.signedIn?g.nsid:t.probableUser)),c.push(this.appContext.getModel("person-contacts-count-models",m))),e.Promise.all(c).catch(function(e){if(e.getModelFailure&&t.probableUser)return t.probableUser=null,[];throw e}).then(function(p){var u,c,g,w=!!p[0]&&p[0],v=0,x={};return o.nsid(l)&&w&&(i=w.getValue("photostreamViewAsPref"),c=n.buildContextSuffix(w,l),m.id=l+"-"+c),n.appContext.getModel("photostream-models",m,r).then(function(p){if(g=p.getValue("owner").getValue("nsid"),YUI.Env.isServer&&(v=Math.ceil(p.getValue("totalItems")/100),h>v&&r.page>1&&!isNaN(parseInt(t.params.page_number,10))))return e.Promise.resolve({redirect:s.replace(/page[0-9]+/,"")});if(o.nsid(l)||(w?(i=w.getValue("photostreamViewAsPref"),c=n.buildContextSuffix(w,g),m.id=g+"-"+c):m.id=g),x.withPhotoId=d,x.contextSuffix=c,x.baseURL=s,x.isHelloPro=P,d){if(u=p.getValue("photoPageList"),-1===(a=u.getPageOf({id:d},50))||u.getNextIncompletePage(r)===a)return r.forceAPICall=!0,o.nsid(l)?r.id=l:r.pathAlias=l,u.getPage(r).then(function(e){return h=Math.ceil(50*u.getPageOf({id:d},50)/100),a=h,n.onRouteResolved(p,h,a,x,f)},function(t){return e.Promise.resolve({redirect:s})});h=Math.ceil(50*u.getPageOf({id:d},50)/100),a=h}else a=2*(h-1)+1;return n.onRouteResolved(p,h,a,x,f)},function(o){return o&&d?e.Promise.resolve({redirect:s}):o.timeout?n.appContext.getModel("person-models",m).then(function(t){var o=t.getValue("displayname"),r={view:"empty-page-view",layout:"scrolling",title:o,params:{geo:f,isSlow:!0,viewAs:i,page:"photostream",displayName:o,nsid:t.getValue("nsid")}};return e.Promise.resolve(r)},function(){return n.onRouteRejected(o,t)}):n.onRouteRejected(o,t,s)})}).catch(function(e){return n.onRouteRejected(e,t,s)})},buildContextSuffix:function(t,o){return e.Models["person-preferences-models"].buildContextSuffix(t,o)},onRouteResolved:function(t,o,r,s,a){var n,l=t.getValue("totalItems"),p=t.getValue("owner").getValue("displayname"),d=t.getValue("owner").getValue("nsid"),u=this.appContext.getViewer(),h=!1;if(0===parseInt(l,10)&&this.appContext.flipper.isFlipped("enable-new-empty-state-pages"))n={view:"empty-page-view",layout:"scrolling",title:p,params:{geo:a,isHelloPro:s.isHelloPro,displayName:p,nsid:e.Models["photostream-models"].splitCompoundId(t.id).nsid,viewAs:i,page:"photostream"}};else{if(h=u.signedIn&&u.nsid===d,this.appContext.flipper.isFlipped("enable-photostream-edit")&&this.isEdit&&!h)return e.Promise.resolve({redirect:s.baseURL.replace(/\/edit/,"")});n={view:this.appContext.flipper.isFlipped("enable-photostream-edit")&&this.isEdit?"photostream-edit-page-view":"photostream-page-view",layout:"scrolling",title:p,params:{geo:a,isHelloPro:s.isHelloPro,nsid:e.Models["photostream-models"].splitCompoundId(t.id).nsid,withPhotoId:s.withPhotoId,isTwitterbot:this.isTwitterbot,contextId:d+"-"+s.contextSuffix,pageParams:{page:r,perPage:s.withPhotoId?100:50,viewPageSize:100,nominalPage:o,idAttribute:"contextId",createCompoundID:!0},baseURL:s.baseURL,contextSuffix:s.contextSuffix}}}return e.Promise.resolve(n)},onRouteRejected:function(t,o,i){if(t.fatal)throw t;return 15===t.code?e.Promise.resolve({redirect:i}):5===t.code?this.displayRouteErrors(o,new e.RouteError(410,this.intlMessage({intlName:"common.404_PHOTOSTREAM_DELETED"}))):this.displayRouteErrors(o,new e.RouteError(404,this.intlMessage({intlName:"common.404_PHOTOSTREAM_NONEXISTENT"})))}}),e.mix(t.prototype,e.Localizable)},"@VERSION@",{requires:["flickr-route","flickr-promise","photostream-models","person-preferences-models"],langBundles:["common"]});